<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendar Puzzle Solver</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .container {
        max-width: 800px;
        width: 100%;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .controls {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group:last-child {
        margin-bottom: 0;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .board-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      #board {
        display: grid;
        gap: 4px;
        margin-top: 20px;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      .cell {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s;
      }

      .cell[role="button"] {
        cursor: pointer;
      }

      .cell.invalid {
        background: transparent;
      }

      .cell.empty {
        background: #f0f0f0;
        border: 2px solid #e0e0e0;
        font-size: 11px;
        color: #999;
      }

      .cell.empty:hover {
        background: #e8e8e8;
        border-color: #667eea;
      }

      .cell.empty:focus,
      .cell.target:focus,
      .cell.piece:focus {
        outline: 3px solid #667eea;
        outline-offset: 2px;
      }

      .cell.target {
        background: #333;
        color: white;
        font-size: 11px;
      }

      .cell:hover {
        filter: brightness(96%);
      }

      .cell.piece {
        color: white;
        font-weight: bold;
        border: 2px solid rgba(0, 0, 0, 0.1);
        font-size: 11px;
      }

      .status {
        text-align: center;
        padding: 15px;
        margin-top: 20px;
        border-radius: 8px;
        font-weight: 600;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      @media (max-width: 600px) {
        h1 {
          font-size: 1.8em;
        }

        .cell {
          font-size: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ“… Calendar Puzzle Solver</h1>

      <div class="board-container">
        <div id="board"></div>
        <div id="status"></div>
      </div>
    </div>

    <script type="module">
      /**
       * Get the current date - uses test stub if available, otherwise real date
       * @returns {Date}
       */
      function getCurrentDate() {
        // Check if a test stub is available
        if (window.__TEST_DATE_STUB__) {
          return new Date(window.__TEST_DATE_STUB__);
        }
        return new Date();
      }

      // Set to today's date
      const today = getCurrentDate();
      const monthNames = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ];

      // Current selected date
      let currentMonth = monthNames[today.getMonth()];
      let currentDay = today.getDate();

      // Create WebWorker for puzzle solving
      const worker = new Worker("solver.worker.js");

      // Track valid cells for rendering (from CalendarPuzzle)
      const validCells = new Set();
      for (let row = 0; row < 2; row++) {
        for (let col = 0; col < 6; col++) {
          validCells.add(`${row},${col}`);
        }
      }
      for (let row = 2; row < 6; row++) {
        for (let col = 0; col < 7; col++) {
          validCells.add(`${row},${col}`);
        }
      }
      for (let col = 0; col < 3; col++) {
        validCells.add(`6,${col}`);
      }

      const months = {
        Jan: [0, 0],
        Feb: [0, 1],
        Mar: [0, 2],
        Apr: [0, 3],
        May: [0, 4],
        Jun: [0, 5],
        Jul: [1, 0],
        Aug: [1, 1],
        Sep: [1, 2],
        Oct: [1, 3],
        Nov: [1, 4],
        Dec: [1, 5],
      };

      const days = {};
      let dayNum = 1;
      for (let row = 2; row < 6; row++) {
        for (let col = 0; col < 7; col++) {
          days[dayNum] = [row, col];
          dayNum++;
        }
      }
      for (let col = 0; col < 3; col++) {
        days[dayNum] = [6, col];
        dayNum++;
      }

      // Piece colors
      const pieceColors = [
        "#FF6B6B",
        "#4ECDC4",
        "#45B7D1",
        "#FFA07A",
        "#98D8C8",
        "#F7DC6F",
        "#BB8FCE",
        "#85C1E2",
      ];

      function renderBoard(month, day, solution) {
        const boardDiv = document.getElementById("board");
        boardDiv.innerHTML = "";

        // Define month and day labels for each position
        const monthLabels = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        const cellLabels = Array(7)
          .fill(null)
          .map(() => Array(7).fill(""));

        // Month labels (rows 0-1)
        for (let i = 0; i < 6; i++) {
          cellLabels[0][i] = monthLabels[i];
          cellLabels[1][i] = monthLabels[i + 6];
        }

        // Day labels (rows 2-6)
        let dayNum = 1;
        for (let r = 2; r < 6; r++) {
          for (let c = 0; c < 7; c++) {
            cellLabels[r][c] = dayNum.toString();
            dayNum++;
          }
        }
        for (let c = 0; c < 3; c++) {
          cellLabels[6][c] = dayNum.toString();
          dayNum++;
        }

        // Create board data structure
        const board = Array(7)
          .fill(null)
          .map(() => Array(7).fill(null));

        // Mark invalid cells
        for (let r = 0; r < 7; r++) {
          for (let c = 0; c < 7; c++) {
            if (!validCells.has(`${r},${c}`)) {
              board[r][c] = { type: "invalid", label: "" };
            } else {
              const isMonth = r < 2; // Rows 0-1 are months
              const isDay = r >= 2; // Rows 2-6 are days
              board[r][c] = {
                type: "empty",
                label: cellLabels[r][c],
                isMonth,
                isDay,
              };
            }
          }
        }

        // Mark target cells
        const monthCell = months[month];
        const dayCell = days[day];
        board[monthCell[0]][monthCell[1]] = {
          type: "target",
          label: month,
          isMonth: true,
          isDay: false,
        };
        board[dayCell[0]][dayCell[1]] = {
          type: "target",
          label: day,
          isMonth: false,
          isDay: true,
        };

        // Place pieces if solution exists
        if (solution) {
          for (const placement of solution) {
            const { pieceIdx, cells } = placement;
            for (const [r, c] of cells) {
              const isMonth = r < 2; // Preserve month/day info
              const isDay = r >= 2;
              board[r][c] = {
                type: "piece",
                pieceIdx,
                label: cellLabels[r][c],
                isMonth,
                isDay,
              };
            }
          }
        }

        // Render all rows
        for (let r = 0; r < 7; r++) {
          const row = document.createElement("div");
          row.className = "row";
          for (let c = 0; c < 7; c++) {
            row.appendChild(createCell(board[r][c]));
          }
          boardDiv.appendChild(row);
        }
      }

      /**
       * Helper function to make a cell interactive with accessibility support
       * @param {HTMLElement} cell - The cell element
       * @param {string} label - The ARIA label
       * @param {Function} onClick - The click handler
       * @param {boolean} isSelected - Whether this is the currently selected cell
       */
      function makeInteractive(cell, label, onClick, isSelected = false) {
        cell.setAttribute("role", "button");
        cell.setAttribute("aria-label", label);
        cell.setAttribute("tabindex", "0");
        if (isSelected) {
          cell.setAttribute("aria-pressed", "true");
        }

        // Click handler
        cell.addEventListener("click", onClick);

        // Keyboard handler
        cell.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            onClick();
          }
        });
      }

      function createCell(data) {
        const cell = document.createElement("div");
        cell.className = "cell";

        if (data.type === "invalid") {
          cell.classList.add("invalid");
        } else if (data.type === "empty") {
          cell.classList.add("empty");
          cell.textContent = data.label;

          // Add click handler for month/day cells
          if (data.isMonth) {
            makeInteractive(cell, `Select ${data.label}`, () => {
              currentMonth = data.label;
              solvePuzzle();
            });
          } else if (data.isDay) {
            makeInteractive(cell, `Select day ${data.label}`, () => {
              currentDay = parseInt(data.label);
              solvePuzzle();
            });
          }
        } else if (data.type === "target") {
          cell.classList.add("target");
          cell.textContent = data.label;

          // Add click handler for target cells
          if (data.isMonth) {
            makeInteractive(
              cell,
              `Current month: ${data.label}. Click to cycle to next month.`,
              () => {
                const monthIndex = monthNames.indexOf(currentMonth);
                currentMonth = monthNames[(monthIndex + 1) % 12];
                solvePuzzle();
              },
              true
            );
          } else if (data.isDay) {
            makeInteractive(
              cell,
              `Current day: ${data.label}. Click to cycle to next day.`,
              () => {
                currentDay = (currentDay % 31) + 1;
                solvePuzzle();
              },
              true
            );
          }
        } else if (data.type === "piece") {
          cell.classList.add("piece");
          cell.style.background = pieceColors[data.pieceIdx];
          cell.textContent = data.label;

          // Add click handler for piece cells too!
          if (data.isMonth) {
            makeInteractive(cell, `Select month ${data.label}`, () => {
              currentMonth = data.label;
              solvePuzzle();
            });
          } else if (data.isDay) {
            makeInteractive(cell, `Select day ${data.label}`, () => {
              currentDay = parseInt(data.label);
              solvePuzzle();
            });
          }
        }

        return cell;
      }

      function showStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
      }

      function solvePuzzle() {
        showStatus("Searching for solution...", "info");
        renderBoard(currentMonth, currentDay, null);

        // Send message to worker
        worker.postMessage({ month: currentMonth, day: currentDay });
      }

      const durFormatter = new Intl.DurationFormat("en-US", { style: "short" });
      worker.addEventListener("message", (e) => {
        const { success, solution, month, day, solveTimeMs, error } = e.data;

        if (success) {
          if (solution) {
            renderBoard(month, day, solution);
            showStatus(
              `âœ“ Solution found in ${durFormatter.format({
                milliseconds: Math.floor(solveTimeMs),
              })}.`,
              "success"
            );
          } else {
            renderBoard(month, day, null);
            showStatus(
              "âœ— No solution found. The puzzle may not be solvable for this date.",
              "error"
            );
          }
        } else {
          showStatus(`Error: ${error}`, "error");
          console.error("Worker error:", error);
        }
      });

      // Initial render and auto-solve on load
      solvePuzzle();
    </script>
  </body>
</html>
